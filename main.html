<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PESMASTER Formation Builder</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>

    </style>
</head>
<body>
    <div class="sidebar">
        <div>
            <label for="name">Name:</label>
            <input type="text" id="name" placeholder="Enter formation name">
        </div>
        <div>
            <label for="lineup">Lineup:</label>
            <select id="lineup">
                <option value="4-4-2">4-4-2</option>
                <option value="4-3-3">4-3-3</option>
                <option value="3-5-2">3-5-2</option>
            </select>
        </div>
        <button class="btn-primary" id="btn-primary">Create new</button>
    </div>

    <div class="main-content">
        <div class="formation" id="formation"></div>
        <h2>Created Players</h2>
        <div id="createdPlayers"></div>
    </div>
    
    <div id="playerModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Select Player</h2>
            <div class="modal-filters">
                <input type="text" id="nameFilter" placeholder="Name">
                <select id="positionFilter">
                    <option value="">Position</option>
                    <option value="CF">CF</option>
                    <option value="LWF">LWF</option>
                    <option value="RWF">RWF</option>
                    <option value="GK">GK</option> 
                    <option value="CB">CB</option>
                    <option value="LB">LB</option> 
                    <option value="CM">CM</option> 
                    <option value="RB">RB</option> 
                    <option value="LW">LW</option>
                    <option value="RW">RW</option>
                    <option value="ST">ST</option>
                </select>
                <select id="nationalityFilter">
                    <option value="">Nationality</option>
                </select>
                <input type="range" id="ratingFilter" min="40" max="99" value="70">
                <span id="ratingValue">70</span>
            </div>
            <div class="players-grid" id="playersGrid"></div>
            <div id="playerCardsContainer" class="players-grid"></div>
        </div>
    </div>

    <div class="modal-content" id="Formulaire_remplir" style="display: none;">
        <h2>Create New Player</h2>
        <form id="newPlayerForm" enctype="multipart/form-data">
            <label for="newPlayerName">Nom Player: </label>
            <input type="text" id="newPlayerName" name="newPlayerName" placeholder="Name" required>
    
            <label for="newPlayerPosition">Position: </label>
            <select id="newPlayerPosition" name="newPlayerPosition" required>
                <option value="" hidden>Position</option>
                <option value="CF">CF</option>
                <option value="LWF">LWF</option>
                <option value="RWF">RWF</option>
                <option value="GK">GK</option>
                <option value="CB">CB</option>
                <option value="LB">LB</option>
                <option value="CM">CM</option>
                <option value="RB">RB</option>
                <option value="LW">LW</option>
                <option value="RW">RW</option>
                <option value="ST">ST</option>
            </select>
    
            <label for="newPlayerNationality">Nationalite: </label>
            <input type="text" id="newPlayerNationality" name="newPlayerNationality" placeholder="Nationality" required>
    
            <label for="newPlayerRating">Rating: </label>
            <input type="number" id="newPlayerRating" name="newPlayerRating" placeholder="Rating" min="40" max="99" required>
    
            <label for="newPlayerPhoto">Photo: </label>
            <input type="file" id="newPlayerPhoto" name="newPlayerPhoto" accept="image/*" required>
    
            <label for="newPlayerFlag">Flag: </label>
            <input type="file" id="newPlayerFlag" name="newPlayerFlag" accept="image/*" required>
    
            <label for="newPlayerLogo">Logo: </label>
            <input type="file" id="newPlayerLogo" name="newPlayerLogo" accept="image/*" required>
    
            <div id="GKFields" class="position-specific" style="display: none;">
                <label for="newPlayerDiving">Diving: </label>
                <input type="number" id="newPlayerDiving" name="newPlayerDiving" min="1" max="99">
                <label for="newPlayerHandling">Handling: </label>
                <input type="number" id="newPlayerHandling" name="newPlayerHandling" min="1" max="99">
                <label for="newPlayerKicking">Kicking: </label>
                <input type="number" id="newPlayerKicking" name="newPlayerKicking" min="1" max="99">
                <label for="newPlayerReflexes">Reflexes: </label>
                <input type="number" id="newPlayerReflexes" name="newPlayerReflexes" min="1" max="99">
                <label for="newPlayerSpeed">Speed: </label>
                <input type="number" id="newPlayerSpeed" name="newPlayerSpeed" min="1" max="99">
                <label for="newPlayerPositioning">Positioning: </label>
                <input type="number" id="newPlayerPositioning" name="newPlayerPositioning" min="1" max="99">
            </div>
    
            <div id="OtherFields" class="position-specific" style="display: none;">
                <label for="newPlayerPace">Pace: </label>
                <input type="number" id="newPlayerPace" name="newPlayerPace" min="1" max="99">
                <label for="newPlayerShooting">Shooting: </label>
                <input type="number" id="newPlayerShooting" name="newPlayerShooting" min="1" max="99">
                <label for="newPlayerPassing">Passing: </label>
                <input type="number" id="newPlayerPassing" name="newPlayerPassing" min="1" max="99">
                <label for="newPlayerDribbling">Dribbling: </label>
                <input type="number" id="newPlayerDribbling" name="newPlayerDribbling" min="1" max="99">
                <label for="newPlayerDefending">Defending: </label>
                <input type="number" id="newPlayerDefending" name="newPlayerDefending" min="1" max="99">
                <label for="newPlayerPhysical">Physical: </label>
                <input type="number" id="newPlayerPhysical" name="newPlayerPhysical" min="1" max="99">
            </div>
    
            <button type="submit">Create Player</button>
        </form>
    </div>
    
    <div id="successMessage">Player created successfully!</div>

    <div id="fol"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const formations = {
                '4-4-2': [
                    [{name: 'ST', index: 0}, {name: 'ST', index: 1}],
                    [{name: 'LM', index: 2}, {name: 'CM', index: 3}, {name: 'CM', index: 4}, {name: 'RM', index: 5}],
                    [{name: 'LB', index: 6}, {name: 'CB', index: 7}, {name: 'CB', index: 8}, {name: 'RB', index: 9}],
                    [{name: 'GK', index: 10}]
                ],
                '4-3-3': [
                    [{name: 'LW', index: 0}, {name: 'ST', index: 1}, {name: 'RW', index: 2}],
                    [{name: 'CM', index: 3}, {name: 'CM', index: 4}, {name: 'CM', index: 5}],
                    [{name: 'LB', index: 6}, {name: 'CB', index: 7}, {name: 'CB', index: 8}, {name: 'RB', index: 9}],
                    [{name: 'GK', index: 10}]
                ],
                '3-5-2': [
                    [{name: 'CF', index: 0}, {name: 'CF', index: 1}],
                    [{name: 'LMF', index: 2}, {name: 'CMF', index: 3}, {name: 'DMF', index: 4}, {name: 'CMF', index: 5}, {name: 'RMF', index: 6}],
                    [{name: 'CB', index: 7}, {name: 'CB', index: 8}, {name: 'CB', index: 9}],
                    [{name: 'GK', index: 10}]
                ]
            };

            let selectedFormation = '4-4-2';
            let selectedPlayers = Array(11).fill(null);
            let currentPosition = null;
            let players = [];

            const formationElement = document.getElementById('formation');
            const lineupSelect = document.getElementById('lineup');
            const modal = document.getElementById('playerModal');
            const closeBtn = document.getElementsByClassName('close')[0];
            const playersGrid = document.getElementById('playersGrid');
            const playerCardsContainer = document.getElementById('playerCardsContainer');
            const nameFilter = document.getElementById('nameFilter');
            const positionFilter = document.getElementById('positionFilter');
            const nationalityFilter = document.getElementById('nationalityFilter');
            const ratingFilter = document.getElementById('ratingFilter');
            const ratingValue = document.getElementById('ratingValue');
            const createdPlayersContainer = document.getElementById('createdPlayers');

            function initializeApp() {
                Promise.all([
                    fetch('../data/data.json').then(response => response.json()),
                    Promise.resolve(JSON.parse(localStorage.getItem('players') || '[]'))
                ]).then(([fetchedData, localStorageData]) => {
                    players = [...fetchedData.players, ...localStorageData];
                    renderFormation();
                    setupEventListeners();
                    populateNationalityFilter();
                    renderCreatedPlayers();
                }).catch(error => {
                    console.error('There was a problem initializing the app:', error);
                });
            }

            function renderFormation() {
                formationElement.innerHTML = '';
                formations[selectedFormation].forEach(row => {
                    const rowElement = document.createElement('div');
                    rowElement.className = 'row';
                    row.forEach(position => {
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.onclick = () => openModal(position.index, position.name);
                        if (selectedPlayers[position.index]) {
                            const player = selectedPlayers[position.index];
                            card.innerHTML = createPlayerCardHTML(player);
                        } else {
                            card.innerHTML = createEmptyCardHTML(position);
                        }
                        rowElement.appendChild(card);
                    });
                    formationElement.appendChild(rowElement);
                });
            }

            function createPlayerCardHTML(player) {
                let cardContent = `
                    <div class="card-inner">
                        <div class="header">
                            <div class="rating">${player.rating}</div>
                            <div class="position">${player.position}</div>
                        </div>
                        <div class="player-image">
                            <img src="${player.photo}" alt="${player.name}" />
                        </div>
                        <div class="player-name">${player.name}</div>
                        <div class="stats">
                `;

                if (player.position === 'GK') {
                    cardContent += `
                        <div class="stat"><span>DIV</span><span>${player.diving}</span></div>
                        <div class="stat"><span>HAN</span><span>${player.handling}</span></div>
                        <div class="stat"><span>KIC</span><span>${player.kicking}</span></div>
                        <div class="stat"><span>REF</span><span>${player.reflexes}</span></div>
                        <div class="stat"><span>SPE</span><span>${player.speed}</span></div>
                        <div class="stat"><span>POS</span><span>${player.positioning}</span></div>
                    `;
                } else {
                    cardContent += `
                        <div class="stat"><span>PAC</span><span>${player.pace}</span></div>
                        <div class="stat"><span>SHO</span><span>${player.shooting}</span></div>
                        <div class="stat"><span>PAS</span><span>${player.passing}</span></div>
                        <div class="stat"><span>DRI</span><span>${player.dribbling}</span></div>
                        <div class="stat"><span>DEF</span><span>${player.defending}</span></div>
                        <div class="stat"><span>PHY</span><span>${player.physical}</span></div>
                    `;
                }

                cardContent += `
                        </div>
                        <div class="flags">
                            <img src="${player.flag}" class="flag" alt="${player.nationality} flag" />
                            <img src="${player.logo}" alt="Team logo" class="flag" />
                        </div>
                    </div>
                `;

                return cardContent;
            }

            function createEmptyCardHTML(position) {
                return `
                    <div>${position.name}</div>
                    <div class="card-inner">
                        <div class="add-icon-container">
                            <span class="add-icon">+</span>
                        </div>
                    </div>
                `;
            }

            function openModal(position, positionName) {
                currentPosition = position;
                modal.style.display = 'block';
                positionFilter.value = positionName;
                renderPlayers();
            }

            function renderPlayers() {
                const filteredPlayers = players.filter(player => 
                    player.name.toLowerCase().includes(nameFilter.value.toLowerCase()) &&
                    (positionFilter.value === '' || isPositionCompatible(player.position, positionFilter.value)) &&
                    (nationalityFilter.value === '' || player.nationality === nationalityFilter.value) &&
                    player.rating >= parseInt(ratingFilter.value)
                );

                playersGrid.innerHTML = '';
                playerCardsContainer.innerHTML = '';
                filteredPlayers.forEach(player => {
                    const playerCard = document.createElement('div');
                    playerCard.className = 'card-inner';
                    playerCard.innerHTML = createPlayerCardHTML(player);
                    playerCard.onclick = () => selectPlayer(player);
                    playersGrid.appendChild(playerCard.cloneNode(true));
                    playerCardsContainer.appendChild(playerCard);
                });
            }

            function selectPlayer(player) {
                selectedPlayers[currentPosition] = player;
                modal.style.display = 'none';
                renderFormation();
            }

            function setupEventListeners() {
                lineupSelect.onchange = (e) => {
                    selectedFormation = e.target.value;
                    selectedPlayers = Array(11).fill(null);
                    renderFormation();
                };

                closeBtn.onclick = () => {
                    modal.style.display = 'none';
                };

                window.onclick = (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                };

                nameFilter.oninput = renderPlayers;
                positionFilter.onchange = renderPlayers;
                nationalityFilter.onchange = renderPlayers;
                ratingFilter.oninput = () => {
                    ratingValue.textContent = ratingFilter.value;
                    renderPlayers();
                };

                document.getElementById('btn-primary').addEventListener('click', function() {
                    document.getElementById('Formulaire_remplir').style.display = 'block';
                });

                document.getElementById('newPlayerForm').addEventListener('submit', handleNewPlayerSubmission);
                document.getElementById('newPlayerPosition').addEventListener('change', togglePositionFields);
            }

            function populateNationalityFilter() {
                const nationalities = [...new Set(players.map(p => p.nationality))];
                nationalityFilter.innerHTML = '<option value="">Nationality</option>';
                nationalities.forEach(nationality => {
                    const option = document.createElement('option');
                    option.value = nationality;
                    option.textContent = nationality;
                    nationalityFilter.appendChild(option);
                });
            }

            function isPositionCompatible(playerPosition, formationPosition) {
                const compatibilityMap = {
                    'CF': ['CF', 'ST'],
                    'LWF': ['LWF', 'LW', 'LM'],
                    'RWF': ['RWF', 'RW', 'RM'],
                    'LMF': ['LMF', 'LM', 'LW'],
                    'RMF': ['RMF', 'RM', 'RW'],
                    'CMF': ['CMF', 'CM'],
                    'DMF': ['DMF', 'CDM'],
                    'LB': ['LB', 'LWB'],
                    'RB': ['RB', 'RWB'],
                    'CB': ['CB'],
                    'GK': ['GK']
                };

                return compatibilityMap[formationPosition]?.includes(playerPosition) || false;
            }

            function renderCreatedPlayers() {
                createdPlayersContainer.innerHTML = '';
                players.forEach(player => {
                    const playerCard = document.createElement('div');
                    playerCard.className = 'card';
                    playerCard.innerHTML = createPlayerCardHTML(player);
                    createdPlayersContainer.appendChild(playerCard);
                });
            }

            function handleNewPlayerSubmission(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const newPlayer = {
                    id: players.length + 1,
                    name: formData.get('newPlayerName'),
                    position: formData.get('newPlayerPosition'),
                    nationality: formData.get('newPlayerNationality'),
                    rating: parseInt(formData.get('newPlayerRating')),
                    photo: URL.createObjectURL(formData.get('newPlayerPhoto')),
                    flag: URL.createObjectURL(formData.get('newPlayerFlag')),
                    logo: URL.createObjectURL(formData.get('newPlayerLogo'))
                };

                if (newPlayer.position === 'GK') {
                    newPlayer.diving = parseInt(formData.get('newPlayerDiving'));
                    newPlayer.handling = parseInt(formData.get('newPlayerHandling'));
                    newPlayer.kicking = parseInt(formData.get('newPlayerKicking'));
                    newPlayer.reflexes = parseInt(formData.get('newPlayerReflexes'));
                    newPlayer.speed = parseInt(formData.get('newPlayerSpeed'));
                    newPlayer.positioning = parseInt(formData.get('newPlayerPositioning'));
                } else {
                    newPlayer.pace = parseInt(formData.get('newPlayerPace'));
                    newPlayer.shooting = parseInt(formData.get('newPlayerShooting'));
                    newPlayer.passing = parseInt(formData.get('newPlayerPassing'));
                    newPlayer.dribbling = parseInt(formData.get('newPlayerDribbling'));
                    newPlayer.defending = parseInt(formData.get('newPlayerDefending'));
                    newPlayer.physical = parseInt(formData.get('newPlayerPhysical'));
                }

                players.push(newPlayer);
                localStorage.setItem('players', JSON.stringify(players.filter(p => !p.id)));
                
                document.getElementById('Formulaire_remplir').style.display = 'none';
                e.target.reset();
                
                populateNationalityFilter();
                renderPlayers();
                renderCreatedPlayers();
                showSuccessMessage();
            }

            function togglePositionFields() {
                const selectedPosition = document.getElementById('newPlayerPosition').value;
                document.getElementById('GKFields').style.display = selectedPosition === 'GK' ? 'block' : 'none';
                document.getElementById('OtherFields').style.display = selectedPosition === 'GK' ? 'none' : 'block';
            }

            function showSuccessMessage() {
                const successMessage = document.getElementById('successMessage');
                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000);
            }

            initializeApp();
        });
    </script>
</body>
</html>